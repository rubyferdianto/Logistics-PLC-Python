<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics PLC Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .status-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-online { border-left-color: #28a745; }
        .status-warning { border-left-color: #ffc107; }
        .status-error { border-left-color: #dc3545; }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .sensor-badge {
            font-size: 0.8rem;
        }
        .alert-item {
            border-left: 3px solid;
            margin-bottom: 0.5rem;
        }
        .alert-warning { border-left-color: #ffc107; }
        .alert-error { border-left-color: #dc3545; }
        .alert-info { border-left-color: #17a2b8; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-industry"></i> Logistics PLC Dashboard
            </a>
            <div class="d-flex">
                <span id="connection-status" class="badge bg-success me-3">
                    <i class="fas fa-circle"></i> Connected
                </span>
                <span class="text-light" id="current-time"></span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- System Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card status-online">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">PLC Status</h6>
                                <div class="metric-value text-success" id="plc-status">Online</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-microchip fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-online">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Active Sensors</h6>
                                <div class="metric-value text-primary" id="active-sensors">8</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-sensors fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-online">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Packages in System</h6>
                                <div class="metric-value text-info" id="packages-count">12</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-box fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Active Alerts</h6>
                                <div class="metric-value text-warning" id="alerts-count">2</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Real-time Sensor Data -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-tachometer-alt"></i> Real-time Sensor Data</h5>
                    </div>
                    <div class="card-body">
                        <div id="sensor-data-container">
                            <!-- Sensor data will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Alerts -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-bell"></i> System Alerts</h5>
                    </div>
                    <div class="card-body">
                        <div id="alerts-container">
                            <!-- Alerts will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Package Tracking -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-shipping-fast"></i> Active Packages</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="packages-table">
                                <thead>
                                    <tr>
                                        <th>Package ID</th>
                                        <th>Barcode</th>
                                        <th>Destination</th>
                                        <th>Current Location</th>
                                        <th>Status</th>
                                        <th>Priority</th>
                                        <th>Received</th>
                                    </tr>
                                </thead>
                                <tbody id="packages-tbody">
                                    <!-- Package data will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Throughput Chart -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Package Throughput (Last 12 Hours)</h5>
                    </div>
                    <div class="card-body">
                        <div id="throughput-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Modal -->
    <div class="modal fade" id="controlModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Actuator Control</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="control-form">
                        <div class="mb-3">
                            <label for="actuator-select" class="form-label">Actuator</label>
                            <select class="form-select" id="actuator-select">
                                <option value="conveyor_start_1">Conveyor 1 - Start/Stop</option>
                                <option value="conveyor_start_2">Conveyor 2 - Start/Stop</option>
                                <option value="speed_setpoint_1">Conveyor 1 - Speed</option>
                                <option value="speed_setpoint_2">Conveyor 2 - Speed</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="command-input" class="form-label">Command/Value</label>
                            <input type="text" class="form-control" id="command-input" placeholder="Enter command or value">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendCommand()">Send Command</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Update current time
        function updateTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Load system status
        function loadSystemStatus() {
            fetch('/api/system/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('active-sensors').textContent = data.active_sensors;
                    document.getElementById('packages-count').textContent = data.packages_in_system;
                    document.getElementById('alerts-count').textContent = data.alerts_count;
                    
                    const plcStatus = document.getElementById('plc-status');
                    const connectionStatus = document.getElementById('connection-status');
                    
                    if (data.plc_connected) {
                        plcStatus.textContent = 'Online';
                        plcStatus.className = 'metric-value text-success';
                        connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Connected';
                        connectionStatus.className = 'badge bg-success me-3';
                    } else {
                        plcStatus.textContent = 'Offline';
                        plcStatus.className = 'metric-value text-danger';
                        connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Disconnected';
                        connectionStatus.className = 'badge bg-danger me-3';
                    }
                })
                .catch(error => console.error('Error loading system status:', error));
        }

        // Load sensor data
        function loadSensorData() {
            fetch('/api/sensors/data')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('sensor-data-container');
                    container.innerHTML = '';
                    
                    data.forEach(sensor => {
                        const statusColor = sensor.status === 'normal' ? 'success' : 
                                          sensor.status === 'warning' ? 'warning' : 'danger';
                        
                        const sensorHtml = `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                <div>
                                    <strong>${sensor.name}</strong><br>
                                    <small class="text-muted">${sensor.location}</small>
                                </div>
                                <div class="text-end">
                                    <span class="h5">${sensor.value} ${sensor.unit}</span><br>
                                    <span class="badge bg-${statusColor} sensor-badge">${sensor.status}</span>
                                </div>
                            </div>
                        `;
                        container.innerHTML += sensorHtml;
                    });
                })
                .catch(error => console.error('Error loading sensor data:', error));
        }

        // Load alerts
        function loadAlerts() {
            fetch('/api/alerts/active')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('alerts-container');
                    container.innerHTML = '';
                    
                    if (data.length === 0) {
                        container.innerHTML = '<p class="text-muted">No active alerts</p>';
                        return;
                    }
                    
                    data.forEach(alert => {
                        const alertHtml = `
                            <div class="alert-item p-2 mb-2 alert-${alert.severity}">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>${alert.title}</strong><br>
                                        <small>${alert.description}</small><br>
                                        <small class="text-muted">${alert.location}</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-${alert.severity === 'warning' ? 'warning' : 
                                                              alert.severity === 'error' ? 'danger' : 'info'}">${alert.severity}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += alertHtml;
                    });
                })
                .catch(error => console.error('Error loading alerts:', error));
        }

        // Load packages
        function loadPackages() {
            fetch('/api/packages/active')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('packages-tbody');
                    tbody.innerHTML = '';
                    
                    data.forEach(package => {
                        const statusColor = package.status === 'delivered' ? 'success' :
                                          package.status === 'error' ? 'danger' : 'primary';
                        const priorityColor = package.priority === 'high' ? 'danger' :
                                            package.priority === 'low' ? 'secondary' : 'warning';
                        
                        const row = `
                            <tr>
                                <td>${package.id}</td>
                                <td>${package.barcode}</td>
                                <td>${package.destination}</td>
                                <td>${package.current_location}</td>
                                <td><span class="badge bg-${statusColor}">${package.status}</span></td>
                                <td><span class="badge bg-${priorityColor}">${package.priority}</span></td>
                                <td>${new Date(package.received_at).toLocaleString()}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                })
                .catch(error => console.error('Error loading packages:', error));
        }

        // Load throughput chart
        function loadThroughputChart() {
            fetch('/api/analytics/throughput')
                .then(response => response.json())
                .then(data => {
                    const hours = Array.from({length: 12}, (_, i) => {
                        const date = new Date();
                        date.setHours(date.getHours() - (11 - i));
                        return date.getHours() + ':00';
                    });
                    
                    const trace = {
                        x: hours,
                        y: data.hourly_throughput,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Packages/Hour',
                        line: {color: '#007bff'}
                    };
                    
                    const layout = {
                        title: 'Package Throughput',
                        xaxis: {title: 'Time'},
                        yaxis: {title: 'Packages per Hour'},
                        margin: {t: 50}
                    };
                    
                    Plotly.newPlot('throughput-chart', [trace], layout, {responsive: true});
                })
                .catch(error => console.error('Error loading throughput chart:', error));
        }

        // Send actuator command
        function sendCommand() {
            const actuatorId = document.getElementById('actuator-select').value;
            const command = document.getElementById('command-input').value;
            
            fetch('/api/control/actuator', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    actuator_id: actuatorId,
                    command: 'set',
                    value: command
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Command sent successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('controlModal')).hide();
                } else {
                    alert('Error sending command: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error sending command:', error);
                alert('Error sending command');
            });
        }

        // Initial load and refresh
        function refreshData() {
            loadSystemStatus();
            loadSensorData();
            loadAlerts();
            loadPackages();
            loadThroughputChart();
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', refreshData);

        // Refresh data every 5 seconds
        setInterval(() => {
            loadSystemStatus();
            loadSensorData();
            loadAlerts();
            loadPackages();
        }, 5000);

        // Refresh chart every minute
        setInterval(loadThroughputChart, 60000);
    </script>
</body>
</html>
