<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè≠ LIVE Logistics PLC Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .status-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .status-online { border-left-color: #28a745; }
        .status-warning { border-left-color: #ffc107; }
        .status-error { border-left-color: #dc3545; }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .sensor-badge {
            font-size: 0.8rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .alert-item {
            border-left: 3px solid;
            margin-bottom: 0.5rem;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .alert-warning { border-left-color: #ffc107; }
        .alert-error { border-left-color: #dc3545; }
        .alert-info { border-left-color: #17a2b8; }
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            animation: blink 1.5s infinite;
            margin-right: 5px;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .control-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .btn-emergency {
            background: linear-gradient(45deg, #dc3545, #c82333);
            border: none;
            color: white;
            font-weight: bold;
            animation: emergency-glow 2s infinite;
        }
        @keyframes emergency-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.5); }
            50% { box-shadow: 0 0 20px rgba(220, 53, 69, 0.8); }
        }
        .package-tracker {
            max-height: 400px;
            overflow-y: auto;
        }
        .package-item {
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #dee2e6;
        }
        .package-item:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-industry"></i> 
                <span class="live-indicator"></span>
                LIVE Logistics PLC Dashboard
            </a>
            <div class="d-flex align-items-center">
                <span id="connection-status" class="badge bg-success me-3">
                    <i class="fas fa-circle"></i> Connected
                </span>
                <span class="text-light" id="current-time"></span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- System Status Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card status-online">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">System Status</h6>
                                <div class="metric-value text-success" id="system-status">üü¢ LIVE</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-microchip fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-online">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Active Sensors</h6>
                                <div class="metric-value text-primary" id="active-sensors">10</div>
                                <small class="text-muted">Real-time monitoring</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-satellite-dish fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-online">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Packages in System</h6>
                                <div class="metric-value text-info" id="packages-count">0</div>
                                <small class="text-muted">Live tracking</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-shipping-fast fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card status-warning" id="alerts-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Active Alerts</h6>
                                <div class="metric-value text-warning" id="alerts-count">0</div>
                                <small class="text-muted">System monitoring</small>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="row">
                <div class="col-md-8">
                    <h5><i class="fas fa-gamepad"></i> Live Control Panel</h5>
                    <div class="btn-group me-3" role="group">
                        <button type="button" class="btn btn-success" onclick="injectPackage()">
                            <i class="fas fa-plus"></i> Add Package
                        </button>
                        <button type="button" class="btn btn-warning" onclick="triggerAlert()">
                            <i class="fas fa-bell"></i> Test Alert
                        </button>
                        <button type="button" class="btn btn-info" onclick="openControlModal()">
                            <i class="fas fa-cog"></i> Control Actuators
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button type="button" class="btn btn-emergency btn-lg" onclick="emergencyStop()">
                        <i class="fas fa-stop"></i> EMERGENCY STOP
                    </button>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Real-time Sensor Data -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-tachometer-alt"></i> Live Sensor Readings</h5>
                        <small>Updates every 3 seconds</small>
                    </div>
                    <div class="card-body">
                        <div id="sensor-data-container" style="max-height: 500px; overflow-y: auto;">
                            <!-- Sensor data will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Alerts -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-bell"></i> Live System Alerts</h5>
                        <small>Real-time notifications</small>
                    </div>
                    <div class="card-body">
                        <div id="alerts-container" style="max-height: 500px; overflow-y: auto;">
                            <!-- Alerts will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Package Tracking -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-shipping-fast"></i> Live Package Tracking</h5>
                        <small>Real-time package movement through the system</small>
                    </div>
                    <div class="card-body">
                        <div class="package-tracker" id="packages-container">
                            <!-- Package data will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Analytics -->
        <div class="row mt-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-chart-line"></i> Live Throughput Analytics</h5>
                    </div>
                    <div class="card-body">
                        <div id="throughput-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="fas fa-chart-pie"></i> System Metrics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-12 mb-3">
                                <h6>System Efficiency</h6>
                                <div class="progress mb-2">
                                    <div id="efficiency-bar" class="progress-bar bg-success" style="width: 85%">85%</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <h6>Packages Today</h6>
                                <div class="metric-value text-primary" id="packages-today">0</div>
                            </div>
                            <div class="col-6">
                                <h6>Processed</h6>
                                <div class="metric-value text-success" id="packages-processed">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Modal -->
    <div class="modal fade" id="controlModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üéÆ Actuator Control</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="control-form">
                        <div class="mb-3">
                            <label for="actuator-select" class="form-label">Actuator</label>
                            <select class="form-select" id="actuator-select">
                                <option value="conveyor_start_1">Conveyor 1 - Start/Stop</option>
                                <option value="conveyor_start_2">Conveyor 2 - Start/Stop</option>
                                <option value="conveyor_start_3">Conveyor 3 - Start/Stop</option>
                                <option value="speed_setpoint_1">Conveyor 1 - Speed</option>
                                <option value="speed_setpoint_2">Conveyor 2 - Speed</option>
                                <option value="diverter_1">Package Diverter</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="command-input" class="form-label">Command/Value</label>
                            <input type="text" class="form-control" id="command-input" placeholder="Enter command or value">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="sendCommand()">Send Command</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let lastUpdateTime = Date.now();
        let alertSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+Dyvmoc');
        
        // Update current time
        function updateTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Show success message
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Load system status
        function loadSystemStatus() {
            fetch('/api/system/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('active-sensors').textContent = data.active_sensors;
                    document.getElementById('packages-count').textContent = data.packages_in_system;
                    document.getElementById('alerts-count').textContent = data.alerts_count;
                    
                    // Update alerts card color based on count
                    const alertsCard = document.getElementById('alerts-card');
                    alertsCard.className = 'card status-card ' + 
                        (data.alerts_count > 5 ? 'status-error' : 
                         data.alerts_count > 0 ? 'status-warning' : 'status-online');
                    
                    // Update efficiency bar
                    const efficiency = parseFloat(data.efficiency);
                    const efficiencyBar = document.getElementById('efficiency-bar');
                    efficiencyBar.style.width = efficiency + '%';
                    efficiencyBar.textContent = data.efficiency;
                    efficiencyBar.className = 'progress-bar ' + 
                        (efficiency > 90 ? 'bg-success' : 
                         efficiency > 75 ? 'bg-warning' : 'bg-danger');
                    
                    // Update other metrics
                    if (data.throughput_today) document.getElementById('packages-today').textContent = data.throughput_today;
                    if (data.packages_processed) document.getElementById('packages-processed').textContent = data.packages_processed;
                })
                .catch(error => console.error('Error loading system status:', error));
        }

        // Load sensor data with animations
        function loadSensorData() {
            fetch('/api/sensors/data')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('sensor-data-container');
                    
                    data.forEach(sensor => {
                        const statusColor = sensor.status === 'normal' ? 'success' : 
                                          sensor.status === 'warning' ? 'warning' : 'danger';
                        
                        let existingElement = document.getElementById(`sensor-${sensor.id}`);
                        
                        const sensorHtml = `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-3 border rounded bg-light sensor-item" 
                                 id="sensor-${sensor.id}" style="transition: all 0.3s ease;">
                                <div>
                                    <strong>${sensor.name}</strong><br>
                                    <small class="text-muted"><i class="fas fa-map-marker-alt"></i> ${sensor.location}</small>
                                </div>
                                <div class="text-end">
                                    <span class="h5">${sensor.value} ${sensor.unit}</span><br>
                                    <span class="badge bg-${statusColor} sensor-badge">${sensor.status.toUpperCase()}</span>
                                </div>
                            </div>
                        `;
                        
                        if (existingElement) {
                            // Update existing element with animation
                            const oldValue = existingElement.querySelector('.h5').textContent.split(' ')[0];
                            const newValue = sensor.value.toString();
                            
                            if (oldValue !== newValue) {
                                existingElement.style.backgroundColor = '#fff3cd';
                                setTimeout(() => {
                                    existingElement.style.backgroundColor = '#f8f9fa';
                                }, 300);
                            }
                            
                            existingElement.outerHTML = sensorHtml;
                        } else {
                            container.innerHTML += sensorHtml;
                        }
                    });
                })
                .catch(error => console.error('Error loading sensor data:', error));
        }

        // Load alerts with sound notification
        function loadAlerts() {
            fetch('/api/alerts/active')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('alerts-container');
                    const currentAlertCount = container.children.length;
                    
                    if (data.length === 0) {
                        container.innerHTML = '<p class="text-muted text-center">üü¢ No active alerts</p>';
                        return;
                    }
                    
                    // Play sound for new alerts
                    if (data.length > currentAlertCount && currentAlertCount > 0) {
                        try {
                            alertSound.play().catch(e => console.log('Audio play failed:', e));
                        } catch (e) {
                            console.log('Audio not supported');
                        }
                    }
                    
                    container.innerHTML = '';
                    data.forEach(alert => {
                        const alertHtml = `
                            <div class="alert-item p-3 mb-2 alert-${alert.severity} border rounded">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong><i class="fas fa-exclamation-triangle"></i> ${alert.title}</strong><br>
                                        <small>${alert.description}</small><br>
                                        <small class="text-muted"><i class="fas fa-map-marker-alt"></i> ${alert.location}</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-${alert.severity === 'warning' ? 'warning' : 
                                                              alert.severity === 'error' ? 'danger' : 'info'} text-dark">
                                            ${alert.severity.toUpperCase()}
                                        </span><br>
                                        <small class="text-muted">${new Date(alert.created_at).toLocaleTimeString()}</small>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += alertHtml;
                    });
                })
                .catch(error => console.error('Error loading alerts:', error));
        }

        // Load packages with real-time tracking
        function loadPackages() {
            fetch('/api/packages/active')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('packages-container');
                    
                    if (data.length === 0) {
                        container.innerHTML = '<p class="text-muted text-center">üì¶ No packages in system</p>';
                        return;
                    }
                    
                    container.innerHTML = '';
                    data.forEach(package => {
                        const statusColor = package.status === 'delivered' ? 'success' :
                                          package.status === 'error' ? 'danger' : 
                                          package.status === 'sorting' ? 'warning' : 'primary';
                        const priorityColor = package.priority === 'high' ? 'danger' :
                                            package.priority === 'low' ? 'secondary' : 'warning';
                        
                        const packageHtml = `
                            <div class="package-item">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <strong>${package.id}</strong><br>
                                        <small class="text-muted">${package.barcode}</small>
                                    </div>
                                    <div class="col-md-2">
                                        <i class="fas fa-map-marker-alt"></i> ${package.destination}<br>
                                        <span class="badge bg-${priorityColor}">${package.priority}</span>
                                    </div>
                                    <div class="col-md-3">
                                        <i class="fas fa-location-arrow"></i> <strong>${package.current_location}</strong><br>
                                        <span class="badge bg-${statusColor}">${package.status}</span>
                                    </div>
                                    <div class="col-md-2">
                                        ${package.weight ? `üì¶ ${package.weight} kg` : ''}
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <small>Received: ${new Date(package.received_at).toLocaleTimeString()}</small><br>
                                        ${package.estimated_delivery ? 
                                          `<small>ETA: ${new Date(package.estimated_delivery).toLocaleTimeString()}</small>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += packageHtml;
                    });
                })
                .catch(error => console.error('Error loading packages:', error));
        }

        // Load throughput chart
        function loadThroughputChart() {
            fetch('/api/analytics/throughput')
                .then(response => response.json())
                .then(data => {
                    const hours = Array.from({length: 12}, (_, i) => {
                        const date = new Date();
                        date.setHours(date.getHours() - (11 - i));
                        return date.getHours() + ':00';
                    });
                    
                    const trace = {
                        x: hours,
                        y: data.hourly_throughput,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Packages/Hour',
                        line: {color: '#28a745', width: 3},
                        marker: {size: 8, color: '#28a745'}
                    };
                    
                    const layout = {
                        title: 'Live Package Throughput',
                        xaxis: {title: 'Time'},
                        yaxis: {title: 'Packages per Hour'},
                        margin: {t: 50},
                        plot_bgcolor: '#f8f9fa',
                        paper_bgcolor: '#ffffff'
                    };
                    
                    Plotly.newPlot('throughput-chart', [trace], layout, {responsive: true});
                })
                .catch(error => console.error('Error loading throughput chart:', error));
        }

        // Interactive functions
        function injectPackage() {
            fetch('/api/system/inject_package', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(`üì¶ ${data.message}`, 'success');
                        loadPackages();
                        loadSystemStatus();
                    }
                })
                .catch(error => showAlert('Error injecting package', 'danger'));
        }

        function triggerAlert() {
            const alerts = [
                {title: 'Test Alert', description: 'This is a test alert for demonstration', location: 'Test Location', severity: 'warning'},
                {title: 'Sensor Calibration', description: 'Sensor requires calibration', location: 'Scanner Station A', severity: 'info'},
                {title: 'High Traffic', description: 'High package volume detected', location: 'Sorting Station', severity: 'warning'}
            ];
            
            const randomAlert = alerts[Math.floor(Math.random() * alerts.length)];
            
            fetch('/api/system/trigger_alert', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(randomAlert)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(`‚ö†Ô∏è ${data.message}`, 'warning');
                        loadAlerts();
                        loadSystemStatus();
                    }
                })
                .catch(error => showAlert('Error triggering alert', 'danger'));
        }

        function emergencyStop() {
            if (confirm('‚ö†Ô∏è Are you sure you want to activate EMERGENCY STOP?')) {
                fetch('/api/system/emergency_stop', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showAlert('üö® EMERGENCY STOP ACTIVATED!', 'danger');
                            loadAlerts();
                        }
                    })
                    .catch(error => showAlert('Error activating emergency stop', 'danger'));
            }
        }

        function openControlModal() {
            new bootstrap.Modal(document.getElementById('controlModal')).show();
        }

        function sendCommand() {
            const actuatorId = document.getElementById('actuator-select').value;
            const command = document.getElementById('command-input').value;
            
            fetch('/api/control/actuator', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({actuator_id: actuatorId, command: 'set', value: command})
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(`üéÆ ${data.message}`, 'success');
                        bootstrap.Modal.getInstance(document.getElementById('controlModal')).hide();
                    }
                })
                .catch(error => showAlert('Error sending command', 'danger'));
        }

        // Auto-refresh functions
        function refreshData() {
            loadSystemStatus();
            loadSensorData();
            loadAlerts();
            loadPackages();
            loadThroughputChart();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            refreshData();
            showAlert('üü¢ Live Dashboard Connected!', 'success');
        });

        // Auto-refresh every 3 seconds
        setInterval(() => {
            loadSystemStatus();
            loadSensorData();
            loadAlerts();
            loadPackages();
        }, 3000);

        // Refresh chart every 30 seconds
        setInterval(loadThroughputChart, 30000);
    </script>
</body>
</html>
